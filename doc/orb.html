<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>orb.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
  <style>
    body {
      font-family: 'Palatino Linotype', 'Hoefler Text', 'Book Antiqua', Palatino, FreeSerif, serif;
    }
    h1,h2,h3,h4,h5,h6 {
      font-weight: normal;
    }
 </style>
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
        <a class="source" href="orb.html">orb.rb</a>
        <a class="source" href="rspec.html">rspec.rb</a>
        </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>orb.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-1">#</a>
        </div>
        <p> ORB is a tool to write tests interactively.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-2">#</a>
        </div>
        <p> Most ruby programmers, even the ones with extensive test suites, frequently
 find themselves in IRB, trying snippets of code here and there.
 It&rsquo;s not uncommon to run some code in IRB, then copy parts of it almost
 verbatim into a test file for use as a test. ORB makes this a much more smooth
 process.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-3">#</a>
        </div>
        <p> The basic workflow with ORB is:</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-4">#</a>
        </div>
        <ol>
<li>Add <code>ORB{}</code> to each new test, at the point where you&rsquo;d like to insert code.</li>
<li>Run your test suite with <code>orb</code> loaded. See <code>adapters/rspec.rb</code>.</li>
<li>Use the REPL provided for each call to ORB to create a new test.</li>
</ol>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-5">#</a>
        </div>
        <p> When a call to <code>ORB</code> is encountered, you&rsquo;ll be dropped to to a REPL with full
 access to the test&rsquo;s context (much like a debugger). You can run code, and
 interact with the context however you like. When you&rsquo;re ready to write your
 test, you simply run the commands, then add them to a buffer. Once your
 buffer contains the code you&rsquo;d like to save as a test, you can write
 it back to the file in place of the call to <code>ORB</code> with just two keystrokes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-6">#</a>
        </div>
        <p> The REPL uses readline for line editing.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;readline&#39;</span></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-7">#</a>
        </div>
        <p> Adapters are near-trivial to write, and provide test-framework integration.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;orb/adapters/rspec&#39;</span>

<span class="k">class</span> <span class="nc">ORB</span>
  <span class="vc">@@index</span><span class="o">=</span><span class="mi">0</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">bind</span><span class="p">)</span>
    <span class="vc">@@index</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="vi">@buf</span><span class="p">,</span> <span class="vi">@hist</span> <span class="o">=</span> <span class="o">[]</span><span class="p">,</span> <span class="o">[]</span>
    <span class="vi">@line</span><span class="p">,</span> <span class="vi">@file</span> <span class="o">=</span> <span class="n">bind</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;[__LINE__, __FILE__]&quot;</span><span class="p">)</span>

    <span class="nb">puts</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">[[ </span><span class="si">#{</span><span class="no">ORB</span><span class="o">::</span><span class="no">Adapter</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="n">bind</span><span class="p">)</span><span class="si">}</span><span class="s2"> ]]&quot;</span>
    
    <span class="k">while</span> <span class="n">line</span> <span class="o">=</span> <span class="no">Readline</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>
      <span class="k">case</span> <span class="n">line</span>
        </pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-8">#</a>
        </div>
        <p> The <code>a</code> command appends one or more recent lines to the test buffer.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">when</span><span class="sr"> /^a\s?(\d*)$/</span>
        <span class="n">append_to_buffer</span><span class="p">(</span><span class="vg">$1</span><span class="o">.</span><span class="n">to_i</span><span class="p">)</span>
        <span class="k">next</span></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-9">#</a>
        </div>
        <p> The <code>h</code> command shows this session&rsquo;s history. Each line starts with
 a coloured space. A red space indicates that this line is not in
 the buffer, and a green space indicates that this line is in the
 buffer, and will be written back to the file when the test is saved.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">when</span> <span class="s2">&quot;h&quot;</span>
        <span class="n">red</span>   <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x1B</span><span class="s2">[41m </span><span class="se">\x1B</span><span class="s2">[m&quot;</span>
        <span class="n">green</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x1B</span><span class="s2">[42m </span><span class="se">\x1B</span><span class="s2">[m&quot;</span>
        <span class="vi">@hist</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="p">,</span> <span class="n">in_buf</span><span class="o">|</span>
          <span class="nb">print</span> <span class="n">in_buf</span> <span class="p">?</span> <span class="n">green</span> <span class="p">:</span> <span class="n">red</span>
          <span class="nb">print</span> <span class="s1">&#39; &#39;</span>
          <span class="nb">puts</span> <span class="n">line</span>
        <span class="k">end</span> 
        <span class="k">next</span> </pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-10">#</a>
        </div>
        <p> The <code>p</code> command prints the current contents of the buffer. If the test
 is written back to the file right now, this is what will be inserted.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">when</span> <span class="s2">&quot;p&quot;</span>
        <span class="nb">puts</span> <span class="vi">@buf</span>
        <span class="k">next</span> 
        </pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-11">#</a>
        </div>
        <p> The <code>q</code> command exits this session without writing a test. Next time
 the suite is run, you&rsquo;ll get a REPL here again.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">when</span> <span class="s2">&quot;q&quot;</span>
        <span class="k">break</span>
        </pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-12">#</a>
        </div>
        <p> The <code>s</code> command writes the contents of the buffer out to the file.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">when</span> <span class="s2">&quot;s&quot;</span>
        <span class="n">write_buf_to_file</span>
        <span class="k">break</span>
        </pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-13">#</a>
        </div>
        <p> If this line wasn&rsquo;t a command, evaluate it in the context of the code
 that called <code>ORB{}</code>. We&rsquo;re stealing that context from the block.
 There are other, trickier tricks to get it without requiring a block,
 but they haven&rsquo;t been reliable since ruby 1.8.5.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">else</span> 
        <span class="vi">@hist</span> <span class="o">&lt;&lt;</span> <span class="o">[</span><span class="n">line</span><span class="p">,</span><span class="kp">false</span><span class="o">]</span>
        <span class="k">begin</span>
          <span class="n">this</span> <span class="o">=</span> <span class="n">bind</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;self&quot;</span><span class="p">)</span>
          <span class="n">ret</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:eval</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">this</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:binding</span><span class="p">))</span>
        <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
          <span class="nb">puts</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span>
        <span class="k">else</span> 
          <span class="nb">puts</span> <span class="n">ret</span><span class="o">.</span><span class="n">inspect</span>
        <span class="k">end</span> 
      <span class="k">end</span> 
      
    <span class="k">end</span> 
  <span class="k">end</span> 

  <span class="kp">private</span></pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-14">#</a>
        </div>
        <p> Append some number of recent lines to the test buffer. This is triggered
 by the command <code>a</code> or <code>a &lt;n&gt;</code>, eg. <code>a 3</code>. If called with no number, just
 appends the last command run, otherwise, appends n lines.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">append_to_buffer</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="vi">@hist</span><span class="o">.</span><span class="n">last</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="vi">@buf</span> <span class="o">&lt;&lt;</span> <span class="vi">@hist</span><span class="o">.</span><span class="n">last</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
  <span class="k">end</span> 
  </pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-15">#</a>
        </div>
        <p> When this command is run, ORB will save the contents of the test buffer
 back into the file where <code>ORB{}</code> was called from. It does this by reading
 in the entire file, then rewriting it with ORB{} replaced by the buffer.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">write_buf_to_file</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="vi">@file</span><span class="p">)</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">to_a</span>
     
    <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="vi">@file</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
      <span class="n">f</span><span class="o">.</span><span class="n">puts</span> <span class="n">lines</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="vi">@line</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span>
     
      <span class="n">orbline</span> <span class="o">=</span> <span class="n">lines</span><span class="o">[</span><span class="vi">@line</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span>
      <span class="n">indentation</span> <span class="o">=</span> <span class="n">orbline</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="sr">/[^\s]/</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-16">#</a>
        </div>
        <p> Here we&rsquo;re indenting the inserted code to the same level as <code>ORB{}</code>
 was indented.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="vi">@buf</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">bufline</span><span class="o">|</span>
        <span class="n">f</span><span class="o">.</span><span class="n">print</span> <span class="s2">&quot; &quot;</span><span class="o">*</span><span class="n">indentation</span>
        <span class="n">f</span><span class="o">.</span><span class="n">puts</span> <span class="n">bufline</span>
      <span class="k">end</span> 
      
      <span class="n">f</span><span class="o">.</span><span class="n">puts</span> <span class="n">lines</span><span class="o">[</span><span class="vi">@line</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span>
    <span class="k">end</span>   
  <span class="k">end</span> 
  </pre></div>
      </td>
    </tr>
    <tr id='section-17'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-17">#</a>
        </div>
        <p> ORB&rsquo;s prompt looks like <code>1:0 &gt;&gt;</code>. The first number is the index of this
 test, starting at one, and incrementing with each test during an
 ORB-enhanced run of your test suite. The second number is the current size
 of the test buffer; that is, the number of lines that will be written to
 the file if the test is saved right now.</p>

      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">prompt</span>
    <span class="s2">&quot;</span><span class="si">#{</span><span class="vc">@@index</span><span class="si">}</span><span class="s2">:</span><span class="si">#{</span><span class="vi">@buf</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2"> &gt;&gt; &quot;</span>
  <span class="k">end</span> 

<span class="k">end</span> </pre></div>
      </td>
    </tr>
    </table>
</div>
</body>
